<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

   <title>Smart IoT Vending</title>
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

 <style>
    body { 
      font-family: Arial, sans-serif; 
      background: black;
      padding: 20px; 
      text-align: center; 
    }

    .card { 
      background: #fffaf3; /* üî• creamy color */
      padding: 20px; 
      margin: 16px auto; 
      max-width: 430px; 
      border-radius: 14px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      
      /* üî• FULL CENTER FIX */
      text-align: center;
    }

    /* Button centered */
    .card button {
      display: block;
      margin: 12px auto 0 auto;
    }

    button {
      padding: 10px 22px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #007bff;
      color:white;
      font-size: 16px;
    }

    button:hover { 
      background: #005fcc; 
    }

    /* Added button green */
    .addedBtn { 
      background: #28a745 !important;
    }

    h2 {
      margin-bottom: 6px;
    }

    p {
      margin: 6px 0;
      color: #333;
    }

    #msg { 
      margin-top: 12px; 
      color: #444; 
      font-weight: bold; 
    }
</style>


</head>

<body>

<h2>Smart IoT Vending</h2>

<div class="card">
  <h3>ü•§ Water ‚Äî ‚Çπ10</h3>
  <button id="btn_water" onclick="toggleItem('WATER',10,'btn_water')">Add Water</button>
</div>

<div class="card">
  <h3>üç™ Biscuit ‚Äî ‚Çπ10</h3>
  <button id="btn_biscuit" onclick="toggleItem('BISCUIT',10,'btn_biscuit')">Add Biscuit</button>
</div>

<div class="card">
  <h3>üßÉ Juice ‚Äî ‚Çπ10</h3>
  <button id="btn_juice" onclick="toggleItem('JUICE',10,'btn_juice')">Add Juice</button>
</div>

<div class="card">
  <h3>Order Summary</h3>
  <p id="summary">No items selected</p>
  <p><b>Total: ‚Çπ<span id="total">0</span></b></p>
  <button onclick="payNow()">Proceed to Pay</button>
  <p id="status"></p>
</div>

<script>
// -------------------- SELECT ITEMS --------------------
let selected = [];
let total = 0;

function toggleItem(name, price, btnId) {
  const btn = document.getElementById(btnId);
  const exists = selected.find(x => x.name === name);

  if (exists) {
    selected = selected.filter(x => x.name !== name);
    total -= price;
    btn.innerText = "Add " + name;
    btn.classList.remove("addedBtn");
  } else {
    selected.push({ name, price });
    total += price;
    btn.innerText = "Added";
    btn.classList.add("addedBtn");
  }

  updateSummary();
}


// ‚úÖ FIXED ORDER SUMMARY FUNCTION
function updateSummary() {
  const summaryDiv = document.getElementById("summary");
  const totalSpan = document.getElementById("total");

  if (selected.length === 0) {
    summaryDiv.innerHTML = "No items selected";
  } else {
    summaryDiv.innerHTML = selected
      .map(i => `- ${i.name} (‚Çπ${i.price})`)
      .join("<br>");
  }

  totalSpan.innerText = total;
}



// -------------------- PAYMENT FLOW --------------------
async function payNow() {
  if (total <= 0) {
    alert("Please select at least one item!");
    return;
  }

  document.getElementById("status").innerText = "Creating payment session...";

  const res = await fetch("/api/create-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: total,
      items: selected.map(i => i.name)
    })
  });

  const data = await res.json();
  console.log("ORDER RESPONSE:", data);

  if (!data.success) {
    document.getElementById("status").innerText = "Payment session error!";
    return;
  }

  const cashfree = await Cashfree({ mode: "production" });

  cashfree.checkout({
    paymentSessionId: data.payment_session_id,
    redirectTarget: "_self"
  }).then(async (result) => {
    console.log("PAYMENT RESULT:", result);

    if (result.paymentDetails?.paymentStatus === "SUCCESS") {
      document.getElementById("status").innerText = "Payment successful! Dispensing...";

      // CALL DISPENSE API
      await fetch("/api/dispense", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items: selected.map(i => i.name)
        })
      });

    } else {
      document.getElementById("status").innerText = "Payment Failed!";
    }
  });
}
</script>


</body>
</html>








