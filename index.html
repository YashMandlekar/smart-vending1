<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Smart IoT Vending (Cashfree Production)</title>

  <!-- Cashfree V3 SDK -->
  <script src="https://sdk.cashfree.com/js/ui/2.0.0/cashfree-ui.js"></script>

  <!-- Firebase (optional for logging) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f1f3f5; 
      padding: 20px; 
      text-align: center; 
    }
    .card { 
      background: #fff; 
      padding: 16px; 
      margin: 14px auto; 
      max-width: 420px; 
      border-radius: 12px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
      text-align: left;
    }
    button {
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #007bff;
      color:white;
      font-size: 15px;
    }
    button:hover { background: #005fcc; }
    .addedBtn { background: #28a745 !important; }
    #msg { margin-top: 10px; color: #333; font-weight: bold; }
  </style>
</head>

<body>

<h2>Smart IoT Vending Machine</h2>
<p>Select items and complete payment</p>

<!-- Items -->
<div class="card">
  <h3>ü•§ Water ‚Äî ‚Çπ10</h3>
  <button id="b1" onclick="toggleItem('Water', 10, 'b1')">Add Water</button>
</div>

<div class="card">
  <h3>üßÉ Juice ‚Äî ‚Çπ10</h3>
  <button id="b2" onclick="toggleItem('Juice', 10, 'b2')">Add Juice</button>
</div>

<div class="card">
  <h3>üç™ Biscuit ‚Äî ‚Çπ10</h3>
  <button id="b3" onclick="toggleItem('Biscuit', 10, 'b3')">Add Biscuit</button>
</div>

<!-- Summary -->
<div class="card">
  <h3>Order Summary</h3>
  <p id="orderList">Items: None</p>
  <p id="totalPrice">Total: ‚Çπ0</p>

  <button onclick="startPayment()">Proceed to Payment</button>
  <p id="msg"></p>
</div>


<script>
// -------------------- SELECT ITEMS --------------------
let selected = [];
let total = 0;

function toggleItem(name, price, btnId) {
  const btn = document.getElementById(btnId);
  const exists = selected.find(x => x.name === name);

  if (exists) {
    selected = selected.filter(x => x.name !== name);
    total -= price;
    btn.innerText = "Add " + name;
    btn.classList.remove("addedBtn");
  } else {
    selected.push({ name, price });
    total += price;
    btn.innerText = "Added";
    btn.classList.add("addedBtn");
  }

  updateSummary();
}

function updateSummary() {
  document.getElementById("orderList").innerHTML = 
    selected.length ? selected.map(i => `- ${i.name} (‚Çπ${i.price})`).join("<br>") : "Items: None";

  document.getElementById("totalPrice").innerText = "Total: ‚Çπ" + total;
}


// -------------------- PAYMENT FLOW --------------------
async function startPayment() {
  if (total <= 0) return alert("Please select items first!");

  document.getElementById("msg").innerText = "Creating order...";

  // 1) CALL BACKEND TO CREATE CASHFREE ORDER
  const res = await fetch("/api/create-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: total,
      items: selected.map(i => i.name)
    })
  });

  const data = await res.json();
  console.log("Order Response:", data);

  if (!data.success || !data.payment_session_id) {
    document.getElementById("msg").innerText = "Order creation failed!";
    return;
  }

  const sessionId = data.payment_session_id;

  const cashfree = await Cashfree({ mode: "production" });

  // 2) OPEN CASHFREE UI
  cashfree.checkout({
    paymentSessionId: sessionId,
    redirectTarget: "_self"
  }).then(async (result) => {

    console.log("Payment Result:", result);

    // PAYMENT SUCCESS
    if (result.paymentDetails?.paymentStatus === "SUCCESS") {
      document.getElementById("msg").innerText = "Payment successful! Dispensing...";

      // 3) CALL DISPENSE API (THIS TRIGGERS BLYNK + ESP32)
      await fetch("/api/dispense", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items: selected.map(i => i.name)
        })
      });

    } else {
      document.getElementById("msg").innerText = "Payment failed!";
    }
  });
}
</script>

</body>
</html>

