<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <style>
    body { font-family: Arial; background:#f7f7f7; text-align:center }
    .card { background:#fff; width:90%; max-width:400px; padding:15px; margin:15px auto; border-radius:10px }
    button { padding:10px 20px; border:none; border-radius:6px; background:#007bff; color:#fff; cursor:pointer }
    .added { background:#28a745!important }
  </style>
</head>

<body>

<h2>Smart IoT Vending</h2>

<div class="card">
  <h3>Water — ₹10</h3>
  <button id="b1" onclick="toggleItem('Water',10,'b1')">Add Water</button>
</div>

<div class="card">
  <h3>Juice — ₹10</h3>
  <button id="b2" onclick="toggleItem('Juice',10,'b2')">Add Juice</button>
</div>

<div class="card">
  <h3>Biscuit — ₹10</h3>
  <button id="b3" onclick="toggleItem('Biscuit',10,'b3')">Add Biscuit</button>
</div>

<div class="card">
  <h3>Order Summary</h3>
  <p id="items">Items: None</p>
  <p id="total">Total: ₹0</p>
  <button onclick="payNow()">Proceed to Payment</button>
  <p id="statusText"></p>
</div>

<script>
let cart = [];
let total = 0;

function toggleItem(name, price, btnId) {
  let btn = document.getElementById(btnId);
  let exists = cart.find(i => i.name === name);

  if (exists) {
    cart = cart.filter(i => i.name !== name);
    total -= price;
    btn.innerText = "Add " + name;
    btn.classList.remove("added");
  } else {
    cart.push({ name, price });
    total += price;
    btn.innerText = "Added";
    btn.classList.add("added");
  }

  updateUI();
}

function updateUI() {
  document.getElementById("items").innerHTML =
    cart.length ? cart.map(i => `- ${i.name} (₹${i.price})`).join("<br>") : "Items: None";

  document.getElementById("total").innerText = "Total: ₹" + total;
}

async function payNow() {
  if (total <= 0) {
    alert("Select at least one item");
    return;
  }

  document.getElementById("statusText").innerText = "Creating order...";

  let res = await fetch("/api/create-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: total,
      items: cart.map(i => i.name)
    })
  });

  let data = await res.json();
  console.log("Backend:", data);

  if (!data.success) {
    alert("Payment session missing!");
    return;
  }

  // Cashfree v3 Handler
  const cashfree = Cashfree({ mode: "production" });

  cashfree.checkout({
    paymentSessionId: data.payment_session_id,
    redirectTarget: "_self"
  });
}
</script>

</body>
</html>

