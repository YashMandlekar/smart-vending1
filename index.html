<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Correct Cashfree SDK v3 -->
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <title>Smart IoT Vending</title>

  <style>
    body { font-family: Arial; background:#f2f2f2; text-align:center; }
    .card { background:#fff; padding:14px; margin:12px auto; width:90%; max-width:400px; border-radius:10px; }
    button { background:#0078ff; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; }
    .added { background:#34a853 !important; }
  </style>
</head>

<body>

<h2>Smart IoT Vending</h2>

<div class="card">
  <h3>ğŸ¥¤ Water â€” â‚¹10</h3>
  <button id="w" onclick="toggleItem('Water',10,'w')">Add Water</button>
</div>

<div class="card">
  <h3>ğŸ§ƒ Juice â€” â‚¹10</h3>
  <button id="j" onclick="toggleItem('Juice',10,'j')">Add Juice</button>
</div>

<div class="card">
  <h3>ğŸª Biscuit â€” â‚¹10</h3>
  <button id="b" onclick="toggleItem('Biscuit',10,'b')">Add Biscuit</button>
</div>

<div class="card">
  <h3>Order Summary</h3>
  <p id="items">No items selected</p>
  <p id="total">Total: â‚¹0</p>
  <button onclick="payNow()">Proceed to Payment</button>
  <p id="msg"></p>
</div>

<script>
let cart = [];
let amount = 0;

// BACKEND URL
const BACKEND = "/api/create-order";   // Correct path for Vercel

function toggleItem(name, price, id){
  const btn = document.getElementById(id);
  const exists = cart.find(x => x.name === name);

  if(exists){
    cart = cart.filter(x => x.name !== name);
    amount -= price;
    btn.innerText = "Add " + name;
    btn.classList.remove("added");
  } else {
    cart.push({ name, price });
    amount += price;
    btn.innerText = "Added";
    btn.classList.add("added");
  }

  updateUI();
}

function updateUI(){
  document.getElementById("items").innerHTML =
    cart.length ? cart.map(x => `- ${x.name} (â‚¹${x.price})`).join("<br>")
                : "No items selected";

  document.getElementById("total").innerText = "Total: â‚¹" + amount;
}

async function payNow(){
  if(amount <= 0){
    alert("Please add an item.");
    return;
  }

  document.getElementById("msg").innerText = "Creating order...";

  const res = await fetch(BACKEND, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      amount: amount,
      items: cart
    })
  });

  const data = await res.json();
  console.log("BACKEND:", data);

  if(!data.payment_session_id){
    alert("Payment session missing!");
    return;
  }

  // Initialize SDK
  const cf = Cashfree({ mode: "production" });   // NO AWAIT IN v3

  cf.checkout({
    paymentSessionId: data.payment_session_id,
    redirectTarget: "_self"
  });
}
</script>

</body>
</html>
