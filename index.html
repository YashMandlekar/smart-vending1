<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CASHFREE NEW UI SDK (Correct + Tested) -->
  <script src="https://sdk.cashfree.com/js/ui/v3/cashfree.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <title>Smart IoT Vending</title>

  <style>
    body { font-family: Arial; background: #f2f2f2; text-align:center; }
    .card { background:#fff; padding:14px; margin:12px auto; width:90%; max-width:400px; border-radius:10px; }
    button { background:#0078ff; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; }
    .addedBtn { background:#34a853 !important; }
  </style>
</head>

<body>

<h2>Smart IoT Vending</h2>

<div class="card">
  <h3>ü•§ Water ‚Äî ‚Çπ10</h3>
  <button id="b1" onclick="toggleItem('Water',10,'b1')">Add Water</button>
</div>

<div class="card">
  <h3>üßÉ Juice ‚Äî ‚Çπ10</h3>
  <button id="b2" onclick="toggleItem('Juice',10,'b2')">Add Juice</button>
</div>

<div class="card">
  <h3>üç™ Biscuit ‚Äî ‚Çπ10</h3>
  <button id="b3" onclick="toggleItem('Biscuit',10,'b3')">Add Biscuit</button>
</div>

<div class="card">
  <h3>Order Summary</h3>
  <p id="orderList">Items: None</p>
  <p id="totalPrice">Total: ‚Çπ0</p>
  <button onclick="initiatePayment()">Proceed to Payment</button>
  <p id="msg"></p>
</div>

<script>
/* ---------------------- FIREBASE ---------------------- */
firebase.initializeApp({
  apiKey: "AIzaSyAPTlRQNFK2xqtRgT6OxEKDX7UphhsIC1c",
  authDomain: "smartvending-a7db9.firebaseapp.com",
  databaseURL: "https://smartvending-a7db9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "smartvending-a7db9"
});

const db = firebase.database();

/* ---------------------- SETTINGS ---------------------- */
const BACKEND_URL = "/api/create-order";  // CORRECT FOR VERCEL PROJECT

/* ---------------------- ITEM LOGIC ---------------------- */
let selected = [];
let total = 0;

function toggleItem(name, price, id) {
  const btn = document.getElementById(id);
  const exists = selected.find(x => x.name === name);

  if (exists) {
    selected = selected.filter(x => x.name !== name);
    total -= price;
    btn.innerText = "Add " + name;
    btn.classList.remove("addedBtn");
  } else {
    selected.push({ name, price });
    total += price;
    btn.innerText = "Added";
    btn.classList.add("addedBtn");
  }
  updateUI();
}

function updateUI() {
  document.getElementById("orderList").innerHTML =
    selected.length ? selected.map(i => `- ${i.name} (‚Çπ${i.price})`).join("<br>") : "Items: None";

  document.getElementById("totalPrice").innerText = "Total: ‚Çπ" + total;
}

/* ---------------------- PAYMENT FLOW ---------------------- */
async function initiatePayment() {
  if (total <= 0) return alert("Please select an item");

  document.getElementById("msg").innerText = "Creating order...";

  const res = await fetch(BACKEND_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: total,
      items: selected.map(x => x.name)
    })
  });

  const data = await res.json();
  console.log("Backend:", data);

  if (!data || !data.payment_session_id) {
    alert("Payment session missing!");
    return;
  }

  // Cashfree instance
  const cf = new Cashfree();

  cf.checkout({
    paymentSessionId: data.payment_session_id,
    returnUrl: window.location.href
  });
}
</script>

</body>
</html>

