<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

   <title>Smart IoT Vending</title>
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

 <style>
    /* --- ORIGINAL STYLES (kept intact) --- */
    body { 
      font-family: Arial, sans-serif; 
      background: #fffaf3;
      padding: 20px; 
      text-align: center; 
    }

    .card { 
      background: #fffaf3; /* üî• creamy color */
      padding: 20px; 
      margin: 16px auto; 
      max-width: 430px; 
      border-radius: 14px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      
      /* üî• FULL CENTER FIX */
      text-align: center;
    }

    /* Button centered */
    .card button {
      display: block;
      margin: 12px auto 0 auto;
    }

    button {
      padding: 10px 22px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #007bff;
      color:white;
      font-size: 16px;
    }

    .addedBtn:hover { background:#28a745 !important; }

    button:hover { 
      background: #005fcc; 
    }

    /* Added button green */
    .addedBtn { 
      background: #28a745 !important;
    }

    h2 {
      margin-bottom: 6px;
    }

    p {
      margin: 6px 0;
      color: #333;
    }

    #msg { 
      margin-top: 12px; 
      color: #444; 
      font-weight: bold; 
    }

    /* --- DARK MODE OVERRIDES (added) --- */
    /* These rules only apply when <html> has class "dark" - they override colours without changing original rules */
    html.dark body {
      background: #0b0f14 !important;
      color: #e6eef5 !important;
    }

    html.dark .card {
      background: #0f1720 !important;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6) !important;
    }

    html.dark p, html.dark h2, html.dark h3 {
      color: #d7e7f5 !important;
    }

    html.dark button {
      background: #0b84ff !important;
      color: white !important;
      border: none !important;
    }

    html.dark button:hover {
      background: #0666c7 !important;
    }

    html.dark .addedBtn {
      background: #28a745 !important;
      color: white !important;
    }

    html.dark #status {
      color: #bfe6c9;
    }

    /* Dark-mode toggle (small UI, kept non-intrusive) */
    .dark-toggle {
      position: fixed;
      right: 18px;
      top: 18px;
      background: rgba(255,255,255,0.85);
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
      font-size: 14px;
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 9999;
    }

    html.dark .dark-toggle {
      background: rgba(10,14,20,0.6);
      color: #e6eef5;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    }

    .dark-toggle input[type="checkbox"]{
      width: 40px;
      height: 22px;
      appearance: none;
      background: #dcdcdc;
      border-radius: 20px;
      position: relative;
      outline: none;
      cursor: pointer;
    }

    .dark-toggle input[type="checkbox"]:after{
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: all 0.18s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .dark-toggle input[type="checkbox"]:checked{
      background: #4b9bff;
    }

    .dark-toggle input[type="checkbox"]:checked:after{
      transform: translateX(18px);
    }

    /* make sure toggle doesn't cover important content on very small screens */
    @media (max-width:420px){
      .dark-toggle{ right: 8px; top: 8px; padding:6px; font-size:13px; }
    }

</style>


</head>

<body>

<!-- DARK MODE TOGGLE (added, non-destructive) -->
<div class="dark-toggle" title="Toggle dark mode">
  <label for="darkModeSwitch">Dark</label>
  <input id="darkModeSwitch" type="checkbox" aria-label="Toggle dark mode">
</div>

<h2>Smart IoT Vending</h2>

<div class="card">
  <h3>ü•§ Water ‚Äî ‚Çπ10</h3>
  <button id="btn_water" onclick="toggleItem('WATER',10,'btn_water')">Add Water</button>
</div>

<div class="card">
  <h3>üç™ Biscuit ‚Äî ‚Çπ10</h3>
  <button id="btn_biscuit" onclick="toggleItem('BISCUIT',10,'btn_biscuit')">Add Biscuit</button>
</div>

<div class="card">
  <h3>üßÉ Juice ‚Äî ‚Çπ10</h3>
  <button id="btn_juice" onclick="toggleItem('JUICE',10,'btn_juice')">Add Juice</button>
</div>

<div class="card">
  <h3>Order Summary</h3>
  <p id="summary">No items selected</p>
  <p><b>Total: ‚Çπ<span id="total">0</span></b></p>
  <button onclick="payNow()">Proceed to Pay</button>
  <p id="status"></p>
</div>

<script>
// -------------------- SELECT ITEMS --------------------
let selected = [];
let total = 0;

function toggleItem(name, price, btnId) {
  const btn = document.getElementById(btnId);
  const exists = selected.find(x => x.name === name);

  if (exists) {
    selected = selected.filter(x => x.name !== name);
    total -= price;
    btn.innerText = "Add " + name;
    btn.classList.remove("addedBtn");
  } else {
    selected.push({ name, price });
    total += price;
    btn.innerText = "Added ‚úì";
    btn.classList.add("addedBtn");
  }

  updateSummary();
}


// ‚úÖ FIXED ORDER SUMMARY FUNCTION
function updateSummary() {
  const summaryDiv = document.getElementById("summary");
  const totalSpan = document.getElementById("total");

  if (selected.length === 0) {
    summaryDiv.innerHTML = "No items selected";
  } else {
    summaryDiv.innerHTML = selected
      .map(i => `- ${i.name} (‚Çπ${i.price})`)
      .join("<br>");
  }

  totalSpan.innerText = total;
}



// -------------------- PAYMENT FLOW --------------------
async function payNow() {
  if (total <= 0) {
    alert("Please select at least one item!");
    return;
  }

  document.getElementById("status").innerText = "Creating payment session...";

  const res = await fetch("/api/create-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: total,
      items: selected.map(i => i.name)
    })
  });

  const data = await res.json();
  console.log("ORDER RESPONSE:", data);

  if (!data.success) {
    document.getElementById("status").innerText = "Payment session error!";
    return;
  }

  const cashfree = await Cashfree({ mode: "production" });

  cashfree.checkout({
    paymentSessionId: data.payment_session_id,
    redirectTarget: "_self"
  }).then(async (result) => {
    console.log("PAYMENT RESULT:", result);

    if (result.paymentDetails?.paymentStatus === "SUCCESS") {
      document.getElementById("status").innerText = "Payment successful! Dispensing...";

      // CALL DISPENSE API
      await fetch("/api/dispense", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items: selected.map(i => i.name)
        })
      });

    } else {
      document.getElementById("status").innerText = "Payment Failed!";
    }
  });
}

// -------------------- DARK MODE TOGGLE LOGIC (added) --------------------
const dmSwitch = document.getElementById('darkModeSwitch');

// initialize from localStorage
(function(){
  try{
    const saved = localStorage.getItem('smart_iot_dark') === '1';
    if(saved){ document.documentElement.classList.add('dark'); dmSwitch.checked = true; }
  }catch(e){ /* ignore */ }
})();

// toggle handler
dmSwitch.addEventListener('change', function(){
  if(this.checked){
    document.documentElement.classList.add('dark');
    try{ localStorage.setItem('smart_iot_dark','1'); }catch(e){}
  } else {
    document.documentElement.classList.remove('dark');
    try{ localStorage.setItem('smart_iot_dark','0'); }catch(e){}
  }
});

</script>


</body>
</html>
