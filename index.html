<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

   <title>Smart IoT Vending</title>
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      text-align: center;
      padding: 20px;
    }
    .card {
      background: white;
      padding: 18px;
      margin: 12px auto;
      max-width: 360px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
    }
    button.added {
      background: #28a745 !important;
    }
  </style>
</head>

<body>

<h2>Smart IoT Vending</h2>

<div class="card">
  <h3>ü•§ Water ‚Äî ‚Çπ10</h3>
  <button id="btn_water" onclick="toggleItem('WATER',10,'btn_water')">Add Water</button>
</div>

<div class="card">
  <h3>üç™ Biscuit ‚Äî ‚Çπ10</h3>
  <button id="btn_biscuit" onclick="toggleItem('BISCUIT',10,'btn_biscuit')">Add Biscuit</button>
</div>

<div class="card">
  <h3>üßÉ Juice ‚Äî ‚Çπ10</h3>
  <button id="btn_juice" onclick="toggleItem('JUICE',10,'btn_juice')">Add Juice</button>
</div>

<div class="card">
  <h3>Order Summary</h3>
  <p id="summary">No items selected</p>
  <p><b>Total: ‚Çπ<span id="total">0</span></b></p>
  <button onclick="payNow()">Proceed to Pay</button>
  <p id="status"></p>
</div>

<script>
// -------------------- SELECT ITEMS --------------------
let selected = [];
let total = 0;

function toggleItem(name, price, btnId) {
  const btn = document.getElementById(btnId);
  const exists = selected.find(x => x.name === name);

  if (exists) {
    selected = selected.filter(x => x.name !== name);
    total -= price;
    btn.innerText = "Add " + name;
    btn.classList.remove("addedBtn");
  } else {
    selected.push({ name, price });
    total += price;
    btn.innerText = "Added";
    btn.classList.add("addedBtn");
  }

  updateSummary();
}

function updateSummary() {
  document.getElementById("orderList").innerHTML = 
    selected.length ? selected.map(i => `- ${i.name} (‚Çπ${i.price})`).join("<br>") : "Items: None";

  document.getElementById("totalPrice").innerText = "Total: ‚Çπ" + total;
}


// -------------------- PAYMENT FLOW --------------------
async function startPayment() {
  if (total <= 0) return alert("Please select items first!");

  document.getElementById("msg").innerText = "Creating order...";

  // 1) CALL BACKEND TO CREATE CASHFREE ORDER
  const res = await fetch("/api/create-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: total,
      items: selected.map(i => i.name)
    })
  });

  const data = await res.json();
  console.log("Order Response:", data);

  if (!data.success || !data.payment_session_id) {
    document.getElementById("msg").innerText = "Order creation failed!";
    return;
  }

  const sessionId = data.payment_session_id;

  const cashfree = await Cashfree({ mode: "production" });

  // 2) OPEN CASHFREE UI
  cashfree.checkout({
    paymentSessionId: sessionId,
    redirectTarget: "_self"
  }).then(async (result) => {

    console.log("Payment Result:", result);

    // PAYMENT SUCCESS
    if (result.paymentDetails?.paymentStatus === "SUCCESS") {
      document.getElementById("msg").innerText = "Payment successful! Dispensing...";

      // 3) CALL DISPENSE API (THIS TRIGGERS BLYNK + ESP32)
      await fetch("/api/dispense", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items: selected.map(i => i.name)
        })
      });

    } else {
      document.getElementById("msg").innerText = "Payment failed!";
    }
  });
}
</script>

</body>
</html>



